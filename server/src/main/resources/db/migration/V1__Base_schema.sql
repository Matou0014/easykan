create table public.users
(
    uuid                   uuid                  not null
        primary key,
    login                  varchar(64)           not null
        unique,
    display_name           varchar(64)           not null,
    email                  varchar(255)          not null
        unique,
    password_hash          varchar(255),
    created_at             timestamp             not null,
    last_login             timestamp,
    permissions            bigint                not null,
    can_auth_with_password boolean               not null
);

create index users_display_name_idx
    on public.users (display_name);

create table public.projects
(
    uuid       uuid         not null
        primary key,
    owner_uuid uuid         not null
        constraint fk_projects_user_uuid
            references public.users,
    name       varchar(255) not null,
    created_at timestamp    not null
);

create index projects_name_idx
    on public.projects (name);

create index projects_owner_uuid_idx
    on public.projects (owner_uuid);

create table public.project_members
(
    project_uuid uuid   not null
        constraint fk_project_members_project_uuid
            references public.projects
            on delete cascade,
    member_uuid  uuid   not null
        constraint fk_project_members_user_uuid
            references public.users
            on delete cascade,
    permissions  bigint not null,
    primary key (project_uuid, member_uuid)
);

create index project_members_member_uuid_idx
    on public.project_members (member_uuid);

create index project_members_project_uuid_idx
    on public.project_members (project_uuid);

create table public.user_tokens
(
    id         bigint generated by default as identity
        primary key,
    selector   varchar(255)            not null
        unique,
    validator  varchar(255)            not null,
    user_uuid  uuid                    not null
        constraint fk_user_tokens_user_uuid
            references public.users
            on delete cascade,
    issued_at  timestamp default now() not null,
    expires_at timestamp               not null,
    revoked    boolean   default false not null
);

create index user_tokens_expires_at_idx
    on public.user_tokens (expires_at);

create index user_tokens_user_uuid_idx
    on public.user_tokens (user_uuid);

